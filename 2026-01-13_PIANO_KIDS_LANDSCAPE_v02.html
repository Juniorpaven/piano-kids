<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Piano Kids Adventure - iOS Fix</title>

    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* =========================================
           1. RESET & CORE LAYOUT
           ========================================= */
        * {
            box-sizing: border-box;
            touch-action: none;
            /* Disable double-tap zoom */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100svh;
            /* Safari Viewport Height fix */
            background-color: #222;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
        }

        /* =========================================
           2. LANDSCAPE VS PORTRAIT LOGIC
           ========================================= */

        /* Default: LANDSCAPE MODE (The Game) */
        #game-container {
            display: flex;
            /* Visible by default (logic flipped by Media Query below) */
            flex-direction: column;
            width: 100vw;
            height: 100svh;
            background: linear-gradient(180deg, #81D4FA 0%, #B3E5FC 100%);
        }

        #rotate-warning {
            display: none;
            /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FF5722;
            color: white;
            z-index: 99999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* IF PORTRAIT -> Show Warning, Hide Game */
        @media screen and (orientation: portrait) {
            #game-container {
                display: none !important;
            }

            #rotate-warning {
                display: flex !important;
            }
        }

        /* IF LANDSCAPE -> Ensure Game is Visible */
        @media screen and (orientation: landscape) {
            #game-container {
                display: flex !important;
            }

            #rotate-warning {
                display: none !important;
            }
        }

        /* =========================================
           3. UI COMPONENTS
           ========================================= */

        /* Toolbar */
        .toolbar {
            height: 60px;
            padding: 0 20px;
            padding-top: max(10px, env(safe-area-inset-top));
            /* Notch Support */
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));

            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .btn {
            background: #FFEB3B;
            border: none;
            border-radius: 30px;
            padding: 8px 20px;
            font-size: 1rem;
            font-weight: bold;
            color: #E65100;
            box-shadow: 0 4px 0 #F57F17;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn.primary {
            background: #4FC3F7;
            color: #01579B;
            box-shadow: 0 4px 0 #0288D1;
        }

        .score-box {
            font-size: 1.5rem;
            font-weight: 900;
            color: #E91E63;
        }

        /* Song Menu Overlay */
        #menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .menu-content {
            background: white;
            width: 80%;
            max-width: 400px;
            max-height: 80vh;
            border-radius: 20px;
            padding: 20px;
            overflow-y: auto;
            text-align: center;
        }

        .song-btn {
            display: block;
            width: 100%;
            background: #E0F7FA;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #B2EBF2;
            border-radius: 10px;
            font-weight: bold;
            color: #006064;
            text-align: left;
        }

        /* =========================================
           4. PIANO KEYBOARD (CSS GRID / FLEX)
           ========================================= */
        #keyboard-scroll-area {
            flex: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            /* No scrolling allowed */
            background: #333;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .keys-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            /* Flexbox for White Keys */
        }

        /* WHITE KEYS */
        .w-key {
            /* 100% / 14 keys = ~7.1428% */
            width: 7.142857%;
            height: 100%;
            background: white;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            border: 1px solid #90A4AE;
            border-top: none;
            position: relative;
            z-index: 5;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 20px;
            box-shadow: inset 0 -10px 0 rgba(0, 0, 0, 0.05);
        }

        .w-key.active {
            background: linear-gradient(to top, #FFEB3B 0%, #fff 100%);
            transform-origin: top;
            transform: scaleY(0.98);
        }

        .w-key.hint {
            background: #B3E5FC !important;
            box-shadow: 0 0 15px #03A9F4;
        }

        .animal-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block;
        }

        .note-text {
            font-size: 1rem;
            font-weight: bold;
            color: #5D4037;
        }

        /* BLACK KEYS */
        /* Absolute positioned relative to container width */
        .b-key {
            position: absolute;
            top: 0;
            width: 4.5%;
            /* Slightly wider for ease of use */
            height: 60%;
            background: linear-gradient(180deg, #424242 0%, #000 100%);
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            z-index: 10;
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
            /* Ensure clickable */
        }

        .b-key.active {
            background: #333;
            border-bottom: 4px solid #D81B60;
            transform: scale(0.95);
        }

        /* Black Key Positions (Calculated for 14-key layout)
           Formula: Left = (KeyIndex * 7.14%) + Offset
           C# (btwn 0-1): ~5%
        */

        /* Octave 4 (First 7 keys: 0 - 50%) */
        .bk-0 {
            left: 4.5%;
        }

        /* C#4 */
        .bk-1 {
            left: 11.5%;
        }

        /* D#4 */
        .bk-2 {
            left: 26%;
        }

        /* F#4 */
        .bk-3 {
            left: 33%;
        }

        /* G#4 */
        .bk-4 {
            left: 40.5%;
        }

        /* A#4 */

        /* Octave 5 (Next 7 keys: 50% - 100%) */
        .bk-5 {
            left: 54.5%;
        }

        /* C#5 */
        .bk-6 {
            left: 61.5%;
        }

        /* D#5 */
        .bk-7 {
            left: 76%;
        }

        /* F#5 */
        .bk-8 {
            left: 83%;
        }

        /* G#5 */
        .bk-9 {
            left: 90.5%;
        }

        /* A#5 */

        /* ANIMATIONS */
        @keyframes bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        .rotate-icon {
            font-size: 4rem;
            animation: bounce 1s infinite;
            display: block;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <!-- PORTRAIT WARNING -->
    <div id="rotate-warning">
        <div class="rotate-icon">üì±‚û°Ô∏è</div>
        <h1>Xoay ngang m√†n h√¨nh</h1>
        <p>ƒê·ªÉ ch∆°i ƒë√†n Piano nh√©!</p>
    </div>

    <!-- MAIN GAME CONTAINER (Visible in Landscape) -->
    <div id="game-container">

        <!-- TOP UI -->
        <div class="toolbar">
            <div style="display:flex; gap:10px;">
                <div class="score-box">üç¨ <span id="score">0</span></div>
            </div>

            <div id="status-text" style="font-weight:bold; color:#0277BD; font-size:1.2rem;">
                T·ª± Do üéπ
            </div>

            <div>
                <button class="btn" onclick="openMenu()">üéµ Ch·ªçn B√†i</button>
            </div>
        </div>

        <!-- PIANO AREA -->
        <div id="keyboard-scroll-area">
            <div class="keys-container" id="piano-keys">
                <!-- Javascript will generate this -->
            </div>
        </div>

    </div>

    <!-- MENU MODAL -->
    <div id="menu-overlay">
        <div class="menu-content">
            <h2 style="color:#E91E63; margin-top:0;">Danh S√°ch Nh·∫°c</h2>
            <div id="song-list-container"></div>
            <button class="btn primary" style="width:100%; margin-top:20px;" onclick="closeMenu()">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // =========================================
        // DATA & CONFIG
        // =========================================
        const ANIMALS = ['üê±', 'üê∂', 'üê≠', 'üê∏', 'üêØ', 'ü¶Ü', 'üêª']; // C D E F G A B
        const NOTES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const BLACK_NOTES = ['C#', 'D#', 'F#', 'G#', 'A#']; // Relative to an octave C, D, F, G, A

        // 2 OCTAVES: 4 and 5
        const OCTAVES = [4, 5];

        // SONGS DATA
        const SONGS = [
            { name: "ƒê√†n G√† Con", notes: ["C4", "C4", "G4", "G4", "A4", "A4", "G4", "F4", "F4", "E4", "E4", "D4", "D4", "C4"] },
            { name: "K√¨a Con B∆∞·ªõm V√†ng", notes: ["C4", "D4", "E4", "C4", "C4", "D4", "E4", "C4", "E4", "F4", "G4", "E4", "F4", "G4"] },
            { name: "Happy Birthday", notes: ["C4", "C4", "D4", "C4", "F4", "E4", "C4", "C4", "D4", "C4", "G4", "F4"] },
            { name: "Twinkle Star", notes: ["C4", "C4", "G4", "G4", "A4", "A4", "G4", "F4", "F4", "E4", "E4", "D4", "D4", "C4"] },
            { name: "Jingle Bells", notes: ["E4", "E4", "E4", "E4", "E4", "E4", "E4", "G4", "C4", "D4", "E4"] }
        ];

        // =========================================
        // STATE
        // =========================================
        let synth = null;
        let score = 0;
        let currentSong = null; // null = free play
        let currentStep = 0;
        let isGuidance = false;

        // =========================================
        // INIT
        // =========================================
        window.onload = () => {
            initPianoUI();
            initAudio();
            document.addEventListener('touchstart', unlockAudio, { once: true });
            document.addEventListener('click', unlockAudio, { once: true });
        };

        async function initAudio() {
            // Tone.js
            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.8 }
            }).toDestination();
        }

        async function unlockAudio() {
            await Tone.start();
            console.log('Audio Context Started');
        }

        // =========================================
        // RENDER UI
        // =========================================
        function initPianoUI() {
            const container = document.getElementById('piano-keys');
            container.innerHTML = '';

            // GENERATE 14 WHITE KEYS (2 OCTAVES)
            let whiteKeyIndex = 0;
            OCTAVES.forEach(oct => {
                NOTES.forEach((n, idx) => {
                    const fullNote = n + oct;
                    const key = document.createElement('div');
                    key.className = 'w-key';
                    key.dataset.note = fullNote;
                    key.innerHTML = `
                        <div style="text-align:center;">
                            <span class="animal-icon">${ANIMALS[idx]}</span>
                            <span class="note-text">${n}</span>
                        </div>
                    `;
                    bindInteraction(key, fullNote);
                    container.appendChild(key);
                    whiteKeyIndex++;
                });
            });

            // GENERATE 10 BLACK KEYS (5 per Octave)
            // Manual placement via CSS Classes .bk-0 to .bk-9
            let blackKeyIndex = 0;
            OCTAVES.forEach(oct => {
                const blacksInOctave = ['C#', 'D#', 'F#', 'G#', 'A#'];
                blacksInOctave.forEach(n => {
                    const fullNote = n + oct;
                    const key = document.createElement('div');
                    key.className = `b-key bk-${blackKeyIndex}`;
                    key.dataset.note = fullNote;
                    bindInteraction(key, fullNote);
                    container.appendChild(key);
                    blackKeyIndex++;
                });
            });

            // GENERATE SONG MENU
            const menuList = document.getElementById('song-list-container');
            // Add Free Play
            const freeBtn = document.createElement('div');
            freeBtn.className = 'song-btn';
            freeBtn.innerText = "üéπ Ch∆°i T·ª± Do";
            freeBtn.onclick = () => selectSong(null);
            menuList.appendChild(freeBtn);

            SONGS.forEach(s => {
                const btn = document.createElement('div');
                btn.className = 'song-btn';
                btn.innerText = "üéµ " + s.name;
                btn.onclick = () => selectSong(s);
                menuList.appendChild(btn);
            });
        }

        function bindInteraction(el, note) {
            // Handle both touch and mouse
            const play = (e) => {
                // e.preventDefault(); // allow default for scrolling? No, preventing default stops zoom.
                // But for touchstart we set CSS touch-action: none, so default usually fine.
                // However, preventing default on touchstart stops mouse emulation.
                if (e.type === 'touchstart' && e.cancelable) e.preventDefault();

                triggerNote(note);
                animateKey(el);
            };

            el.addEventListener('touchstart', play, { passive: false });
            el.addEventListener('mousedown', play);
        }

        // =========================================
        // GAME LOGIC
        // =========================================
        function triggerNote(note) {
            if (!synth) return;
            synth.triggerAttackRelease(note, "8n");

            // Check Game Logic
            if (isGuidance && currentSong) {
                const target = currentSong.notes[currentStep];
                if (note === target) {
                    // Correct!
                    addScore(5);
                    currentStep++;
                    if (currentStep >= currentSong.notes.length) {
                        // Win
                        updateStatus(`Ho√†n th√†nh! üéâ +50ƒë`);
                        addScore(50);
                        setTimeout(() => selectSong(null), 2000);
                    } else {
                        showHint(currentSong.notes[currentStep]);
                    }
                }
            } else {
                // Free play
                addScore(1);
            }
        }

        function animateKey(el) {
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), 150);
        }

        function addScore(val) {
            score += val;
            document.getElementById('score').innerText = score;
        }

        function updateStatus(text) {
            document.getElementById('status-text').innerText = text;
        }

        function selectSong(song) {
            currentSong = song;
            closeMenu();
            currentStep = 0;

            // Clear Hints
            document.querySelectorAll('.hint').forEach(k => k.classList.remove('hint'));

            if (song) {
                isGuidance = true;
                updateStatus(`T·∫≠p: ${song.name}`);
                showHint(song.notes[0]);
            } else {
                isGuidance = false;
                updateStatus("T·ª± Do üéπ");
            }
        }

        function showHint(note) {
            // Remove old hints
            document.querySelectorAll('.hint').forEach(k => k.classList.remove('hint'));

            // Find key
            // Note could be "C4" or "C#4"
            // Our dataset matches exact note string
            const key = document.querySelector(`div[data-note="${note}"]`);
            if (key) key.classList.add('hint');
        }

        // =========================================
        // MENU CONTROLS
        // =========================================
        function openMenu() {
            document.getElementById('menu-overlay').style.display = 'flex';
        }

        function closeMenu() {
            document.getElementById('menu-overlay').style.display = 'none';
        }

    </script>
</body>

</html>